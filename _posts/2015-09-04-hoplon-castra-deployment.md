---
layout: post
title: 'Hoplon, Castra и Deployment'
date: 2015-09-04 22:38
comments: true
categories: 
---
Последние пару дней занимался dashboard'ом, для мониторинга нескольких показателей железки, стоящей на поезде. Это ни коим образом не замена Grafana или Kibana, просто красивая морда для внешних людей. Что-то вроде "Impressions Dashboard".

Я первый раз делаю что-то длиннее нескольких строчек на Clojure. Так что, сначала было не очень просто, но ничего существенного. Не сразу разобрался с моделью ячеек и кастомных компонентов в Hoplon (когда надо было отобразить движение поезда на Google Maps без перезагрузки, чтобы не было слишком много обращений).

В целом, мои ожидания оправдались. Всё сделалось быстро и без особых проблем.

Дошло дело до развёртывания всего этого добра. Тут-то и было подвох.

<!--more-->

Hoplon использует boot как систему сборки, потому что ему нужны кастомные шаги.

Разрабатывать всё очень просто. Просто запускаешь команду `boot development` и ни о чём не думаешь. Он компилирует ClojureScript, делает reloding в браузере, стартует web-сервер для backend'а.

Встал вопрос, а как же люди вообще разворачивают web-приложения на Clojure? Неплохой обзор, а что же бывает есть тут: <http://www.luminusweb.net/docs/deployment.md>. Бегло проглядев, я решил, что надо начать с uberwar. Но как его сделать с boot совершенно не понятно.

В итоге, после некоторого количества гугления был найден ответ: надо немного подправить тот шаблон, который создаётся после `lein new hoplon-castra`, и надо добавить отдельный task в `build.boot` (это есть в примере `deploy-uberwar` из `hoplon-demos`). Либо можно сделать `boot lein-generate`, чтобы получить `project.clj` и вписать туда `lein-ring` руками, после чего заработает `lein ring uberwar`.

Однако, сколько я его не запускал, я всё время получал процесс, который не завершается и ничего не делает. В сети был найден ответ, что причина в том, что в namespace есть действия, которые выполняются долго, либо висят. В моём случае это было

``` clojure
(at/every 10000 #(reset! state (update-state conn)) my-pool)
```

Чтобы делать инициализацию в настройках Ring есть параметр `:init`.

Как это подружить с `boot development` пока не очень ясно, ведь он использует `castra-dev-server`, который без параметров и который уже вычищен из исходников castra. Вероятнее всего надо будет сделать кастомную обёртку над jetty и звать её.